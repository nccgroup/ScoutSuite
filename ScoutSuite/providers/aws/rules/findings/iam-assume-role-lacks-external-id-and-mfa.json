{
    "description": "Cross-Account AssumeRole Policy Lacks External ID and MFA",
    "rationale": "When authorizing cross-account role assumption, either an External ID or MFA should be required. If the role is intended for use by a service, an External ID can prevent \"confused deputy\" attacks. If the role is intended for use by an external user, then MFA will strengthen the authentication by requiring a second factor.",
    "references": [
        "https://research.nccgroup.com/2019/12/18/demystifying-aws-assumerole-and-stsexternalid/",
        "https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user_externalid.html"
    ],
    "dashboard_name": "Roles",
    "display_path": "iam.roles.id",
    "path": "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id",
    "conditions": [
        "and",
        [
            "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id.Effect",
            "equal",
            "Allow"
        ],
        [
            "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id.",
            "containAction",
            "sts:AssumeRole"
        ],
        [
            "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id.Principal",
            "withKey",
            "AWS"
        ],
        [
            "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id.Principal.AWS",
            "isCrossAccount",
            "_ACCOUNT_ID_"
        ],
        [
            "or",
            [
                "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id.",
                "withoutKey",
                "Condition"
            ],
            [
                "and",
                [
                    "or",
                    [
                        "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id.Condition",
                        "withoutKey",
                        "Bool"
                    ],
                    [
                        "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id.Condition.Bool.",
                        "withoutKey",
                        "aws:MultiFactorAuthPresent"
                    ],
                    [
                        "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id.Condition.Bool.aws:MultiFactorAuthPresent",
                        "notTrue",
                        ""
                    ]
                ],
                [
                    "or",
                    [
                        "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id.Condition",
                        "withoutKey",
                        "BoolIfExists"
                    ],
                    [
                        "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id.Condition.BoolIfExists.",
                        "withoutKey",
                        "aws:MultiFactorAuthPresent"
                    ],
                    [
                        "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id.Condition.BoolIfExists.aws:MultiFactorAuthPresent",
                        "notTrue",
                        ""
                    ]
                ]
            ]
        ],
        [
            "or",
            [
                "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id.",
                "withoutKey",
                "Condition"
            ],
            [
                "and",
                [
                    "or",
                    [
                        "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id.Condition",
                        "withoutKey",
                        "StringEquals"
                    ],
                    [
                        "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id.Condition.StringEquals.",
                        "withoutKey",
                        "sts:ExternalId"
                    ],
                    [
                        "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id.Condition.StringEquals.sts:ExternalId",
                        "empty",
                        ""
                    ]
                ],
                [
                    "or",
                    [
                        "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id.Condition",
                        "withoutKey",
                        "StringLike"
                    ],
                    [
                        "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id.Condition.StringLike.",
                        "withoutKey",
                        "sts:ExternalId"
                    ],
                    [
                        "iam.roles.id.assume_role_policy.PolicyDocument.Statement.id.Condition.StringLike.sts:ExternalId",
                        "empty",
                        ""
                    ]
                ]
            ]
        ]
    ]
}
